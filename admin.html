<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>NOIPRO License Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
      background: #f3f4f6;
      color: #111827;
    }
    h1 {
      margin: 0 0 10px;
      text-align: center;
      font-size: 24px;
      color: #1f2937;
    }
    .card {
      max-width: 1100px;
      margin: 0 auto;
      background: #fff;
      padding: 18px;
      border-radius: 14px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.12);
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .full { flex: 1 1 100%; }
    .half { flex: 1 1 calc(50% - 10px); }
    .third { flex: 1 1 calc(33.3% - 10px); }
    label {
      font-size: 12px;
      color: #4b5563;
      display: block;
      margin-bottom: 2px;
    }
    input, select {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 7px 9px;
      font-size: 13px;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb33;
    }
    button {
      border-radius: 8px;
      border: none;
      padding: 7px 12px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button.primary { background: #2563eb; color: #fff; }
    button.secondary { background: #e5e7eb; color: #111827; }
    button.danger { background: #dc2626; color: #fff; }
    button.warn { background: #f97316; color: #fff; }
    button:disabled { opacity: .6; cursor: default; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #eff6ff;
      color: #1d4ed8;
      margin-left: 6px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }
    th, td {
      padding: 6px 7px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    th {
      background: #f9fafb;
      font-weight: 600;
      color: #4b5563;
    }
    tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    .statusbar {
      margin-top: 8px;
      font-size: 12px;
      color: #6b7280;
    }
    .chip {
      display: inline-block;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 11px;
      background: #ecfdf5;
      color: #15803d;
    }
    .chip.expired {
      background: #fef2f2;
      color: #b91c1c;
    }
    .chip.revoked {
      background: #fef2f2;
      color: #7f1d1d;
      border: 1px solid #fecaca;
    }
    .right { text-align: right; }

    @media (max-width: 768px) {
      .half, .third { flex: 1 1 100%; }
      table { font-size: 12px; }
    }
  </style>
</head>
<body>
<div class="card">
  <h1>
    NOIPRO License Admin
    <span class="badge">Online</span>
  </h1>

  <!-- c·∫•u h√¨nh -->
  <div class="row">
    <div class="half">
      <label>Admin secret (ADMIN_SECRET tr√™n Vercel)</label>
      <input id="secret" type="password" placeholder="Nh·∫≠p ADMIN_SECRET">
    </div>
    <div class="half">
      <label>API base URL</label>
      <input id="baseUrl" type="text"
             value="https://noipro-license-server.vercel.app">
    </div>
  </div>
  <div class="row">
    <div class="third">
      <button id="btnLoad" class="primary">üîÑ T·∫£i danh s√°ch</button>
    </div>
    <div class="third">
      <label>T√¨m ki·∫øm</label>
      <input id="search" type="text" placeholder="Key / m√°y / ghi ch√∫...">
    </div>
    <div class="third">
      <label>S·∫Øp x·∫øp</label>
      <select id="sort">
        <option value="key">Theo key</option>
        <option value="machineId">Theo m√°y</option>
        <option value="expiresAt">Theo ng√†y h·∫øt h·∫°n</option>
        <option value="updatedAt">Theo ng√†y c·∫≠p nh·∫≠t</option>
      </select>
    </div>
  </div>

  <hr style="border:none;border-top:1px solid #e5e7eb;margin:10px 0;">

  <!-- form th√™m / s·ª≠a -->
  <div class="row">
    <div class="third">
      <label>Key</label>
      <input id="fKey" type="text" placeholder="VD: NOIPRO-ABC-123">
    </div>
    <div class="third">
      <label>Machine ID</label>
      <input id="fMachine" type="text" placeholder="M√£ m√°y (UUID)">
    </div>
    <div class="third">
      <label>H·∫øt h·∫°n</label>
      <input id="fExpires" type="date">
    </div>
  </div>
  <div class="row">
    <div class="half">
      <label>Ghi ch√∫</label>
      <input id="fNote" type="text" placeholder="VD: Th·∫ßy A, ph√≤ng Tin...">
    </div>
    <div class="half" style="text-align:right;">
      <button id="btnAddUpdate" class="primary">üíæ Th√™m / C·∫≠p nh·∫≠t</button>
    </div>
  </div>

  <!-- b·∫£ng -->
  <table>
    <thead>
      <tr>
        <th>Key</th>
        <th>Machine</th>
        <th>H·∫øt h·∫°n</th>
        <th>Ghi ch√∫</th>
        <th>Tr·∫°ng th√°i</th>
        <th class="right">Thao t√°c</th>
      </tr>
    </thead>
    <tbody id="tblBody"></tbody>
  </table>

  <div id="status" class="statusbar">S·∫µn s√†ng.</div>
</div>

<script>
  let licenses = [];

  function cfg() {
    const baseUrl = document.getElementById('baseUrl').value.trim().replace(/\/+$/, '');
    const secret = document.getElementById('secret').value.trim();
    if (!baseUrl || !secret) {
      alert("Nh·∫≠p ƒë·∫ßy ƒë·ªß API base URL v√† ADMIN_SECRET tr∆∞·ªõc.");
      throw new Error("missing cfg");
    }
    return { baseUrl, secret };
  }

  function setStatus(msg) {
    document.getElementById('status').textContent = msg;
  }

  function render() {
    const tbody = document.getElementById('tblBody');
    tbody.innerHTML = "";

    const search = document.getElementById('search').value.toLowerCase();
    const sort = document.getElementById('sort').value;

    let rows = licenses.slice();

    if (search) {
      rows = rows.filter(l => {
        return (l.key || "").toLowerCase().includes(search) ||
               (l.machineId || "").toLowerCase().includes(search) ||
               (l.note || "").toLowerCase().includes(search);
      });
    }

    rows.sort((a,b) => {
      const va = (a[sort] || "").toString();
      const vb = (b[sort] || "").toString();
      return va.localeCompare(vb);
    });

    const today = new Date().toISOString().slice(0,10);

    for (const lic of rows) {
      const tr = document.createElement('tr');

      const tdKey = document.createElement('td');
      tdKey.textContent = lic.key || "";
      tr.appendChild(tdKey);

      const tdMach = document.createElement('td');
      tdMach.textContent = lic.machineId || "";
      tr.appendChild(tdMach);

      const tdExp = document.createElement('td');
      const spanExp = document.createElement('span');
      const exp = lic.expiresAt || "";
      spanExp.textContent = exp || "(kh√¥ng ƒë·∫∑t)";
      if (exp && exp < today) {
        spanExp.className = "chip expired";
      } else if (exp) {
        spanExp.className = "chip";
      }
      tdExp.appendChild(spanExp);
      tr.appendChild(tdExp);

      const tdNote = document.createElement('td');
      tdNote.textContent = lic.note || "";
      tr.appendChild(tdNote);

      const tdStatus = document.createElement('td');
      if (lic.revoked) {
        const c = document.createElement('span');
        c.className = "chip revoked";
        c.textContent = "ƒê√É THU H·ªíI";
        tdStatus.appendChild(c);
      } else if (exp && exp < today) {
        const c = document.createElement('span');
        c.className = "chip expired";
        c.textContent = "H·∫æT H·∫†N";
        tdStatus.appendChild(c);
      } else {
        const c = document.createElement('span');
        c.className = "chip";
        c.textContent = "ƒêANG HO·∫†T ƒê·ªòNG";
        tdStatus.appendChild(c);
      }
      tr.appendChild(tdStatus);

      const tdAction = document.createElement('td');
      tdAction.className = "right";

      const btnEdit = document.createElement('button');
      btnEdit.className = "secondary";
      btnEdit.textContent = "‚úè S·ª≠a";
      btnEdit.onclick = () => {
        document.getElementById('fKey').value = lic.key || "";
        document.getElementById('fMachine').value = lic.machineId || "";
        document.getElementById('fExpires').value = (lic.expiresAt || "").slice(0,10);
        document.getElementById('fNote').value = lic.note || "";
        window.scrollTo({ top: 0, behavior: "smooth" });
      };
      tdAction.appendChild(btnEdit);

      const btnRevoke = document.createElement('button');
      btnRevoke.className = lic.revoked ? "secondary" : "warn";
      btnRevoke.textContent = lic.revoked ? "‚Ü© B·ªè thu h·ªìi" : "‚õî Thu h·ªìi";
      btnRevoke.style.marginLeft = "4px";
      btnRevoke.onclick = () => toggleRevoke(lic.key, !lic.revoked);
      tdAction.appendChild(btnRevoke);

      const btnDel = document.createElement('button');
      btnDel.className = "danger";
      btnDel.textContent = "üóë X√≥a";
      btnDel.style.marginLeft = "4px";
      btnDel.onclick = () => deleteLicense(lic.key);
      tdAction.appendChild(btnDel);

      tr.appendChild(tdAction);

      tbody.appendChild(tr);
    }
  }

  async function loadLicenses() {
    let c;
    try { c = cfg(); } catch { return; }
    setStatus("ƒêang t·∫£i danh s√°ch...");
    document.getElementById('btnLoad').disabled = true;
    try {
      const url = `${c.baseUrl}/api/admin?secret=${encodeURIComponent(c.secret)}`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Server ok=false");
      licenses = data.licenses || [];
      render();
      setStatus(`ƒê√£ t·∫£i ${licenses.length} license.`);
    } catch (err) {
      console.error(err);
      alert("L·ªói t·∫£i danh s√°ch: " + err.message);
      setStatus("L·ªói t·∫£i danh s√°ch.");
    } finally {
      document.getElementById('btnLoad').disabled = false;
    }
  }

  async function addOrUpdateLicense() {
    let c;
    try { c = cfg(); } catch { return; }

    const key = document.getElementById('fKey').value.trim();
    const machine = document.getElementById('fMachine').value.trim();
    const exp = document.getElementById('fExpires').value; // yyyy-mm-dd
    const note = document.getElementById('fNote').value.trim();

    if (!key) { alert("Key kh√¥ng ƒë∆∞·ª£c b·ªè tr·ªëng."); return; }
    if (!machine) { alert("MachineId kh√¥ng ƒë∆∞·ª£c b·ªè tr·ªëng."); return; }

    const expiresAt = exp || "";

    setStatus("ƒêang g·ª≠i l√™n server...");
    document.getElementById('btnAddUpdate').disabled = true;
    try {
      const url = `${c.baseUrl}/api/add?secret=${encodeURIComponent(c.secret)}`
        + `&key=${encodeURIComponent(key)}`
        + `&machineId=${encodeURIComponent(machine)}`
        + `&expiresAt=${encodeURIComponent(expiresAt)}`
        + `&note=${encodeURIComponent(note)}`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Server ok=false");
      setStatus("ƒê√£ th√™m / c·∫≠p nh·∫≠t. ƒêang reload...");
      await loadLicenses();
    } catch (err) {
      console.error(err);
      alert("L·ªói th√™m/c·∫≠p nh·∫≠t: " + err.message);
      setStatus("L·ªói th√™m/c·∫≠p nh·∫≠t.");
    } finally {
      document.getElementById('btnAddUpdate').disabled = false;
    }
  }

  async function deleteLicense(key) {
    if (!confirm("X√≥a license v·ªõi key:\n" + key + " ?")) return;
    let c;
    try { c = cfg(); } catch { return; }
    setStatus("ƒêang x√≥a...");
    try {
      const res = await fetch(`${c.baseUrl}/api/admin?secret=${encodeURIComponent(c.secret)}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "delete", key })
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Server ok=false");
      setStatus("ƒê√£ x√≥a. ƒêang reload...");
      await loadLicenses();
    } catch (err) {
      console.error(err);
      alert("L·ªói x√≥a license: " + err.message);
      setStatus("L·ªói x√≥a license.");
    }
  }

  async function toggleRevoke(key, revoke) {
    let c;
    try { c = cfg(); } catch { return; }
    if (revoke && !confirm("Thu h·ªìi license n√†y? Ng∆∞·ªùi d√πng s·∫Ω m·∫•t k√≠ch ho·∫°t khi ki·ªÉm tra l·∫°i.")) return;
    setStatus(revoke ? "ƒêang thu h·ªìi..." : "ƒêang b·ªè thu h·ªìi...");
    try {
      const res = await fetch(`${c.baseUrl}/api/admin?secret=${encodeURIComponent(c.secret)}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: revoke ? "revoke" : "unrevoke", key })
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Server ok=false");
      setStatus("OK. ƒêang reload...");
      await loadLicenses();
    } catch (err) {
      console.error(err);
      alert("L·ªói thu h·ªìi / b·ªè thu h·ªìi: " + err.message);
      setStatus("L·ªói thu h·ªìi / b·ªè thu h·ªìi.");
    }
  }

  document.getElementById('btnLoad').onclick = loadLicenses;
  document.getElementById('btnAddUpdate').onclick = addOrUpdateLicense;
  document.getElementById('search').oninput = render;
  document.getElementById('sort').onchange = render;
</script>
</body>
</html>
